name: stwo CUDA Runtime (H100)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "stwo/**"
      - "stwo-ml/**"
      - "proof-stream/**"
      - ".github/workflows/stwo-cuda-runtime-h100.yml"
  push:
    branches: [main]
    paths:
      - "stwo/**"
      - "stwo-ml/**"
      - "proof-stream/**"
      - ".github/workflows/stwo-cuda-runtime-h100.yml"

concurrency:
  group: cuda-h100-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  cuda-runtime-strict:
    runs-on: [self-hosted, linux, x64, gpu, h100]
    timeout-minutes: 90
    env:
      CUDA_HOME: /usr/local/cuda
      STWO_GPU_POLY_STRICT: "1"
      STWO_GPU_POLY_HARDEN: "1"
      RUST_BACKTRACE: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            stwo/crates/stwo
            stwo-ml

      - name: Verify CUDA Runtime
        run: |
          nvidia-smi
          nvcc --version

      - name: Manifest Validation
        working-directory: stwo-ml
        run: cargo metadata --no-deps --format-version 1 > /dev/null

      - name: Build stwo (cuda-runtime)
        working-directory: stwo/crates/stwo
        run: cargo check --features "prover,gpu,cuda-runtime"

      - name: GPU Quotient Kernel Tests
        working-directory: stwo/crates/stwo
        run: |
          cargo test --features "prover,gpu,cuda-runtime" --lib test_gpu_quotient_ops_compiles -- --nocapture
          cargo test --features "prover,gpu,cuda-runtime" --lib test_pcs_quotient_kernel_source_compiles -- --nocapture

      - name: Build stwo-ml (cuda-runtime)
        working-directory: stwo-ml
        run: cargo check --features "cli,audit,cuda-runtime"

      - name: stwo-ml Soundness Gates (strict)
        working-directory: stwo-ml
        run: |
          cargo test --features "audit,cuda-runtime" --lib gkr_soundness_gate_rejects_missing_activation_logup -- --nocapture
          cargo test --features "audit,cuda-runtime" --lib gkr_soundness_gate_rejects_missing_weight_openings -- --nocapture

      - name: stwo-ml CUDA End-to-End Sanity
        working-directory: stwo-ml
        run: |
          cargo test --features "cli,audit,cuda-runtime" --lib starknet::tests::test_prove_for_starknet_ml_gkr_pipeline -- --nocapture
